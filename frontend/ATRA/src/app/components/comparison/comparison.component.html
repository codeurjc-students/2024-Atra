

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0" *ngIf="activities">Comparing activities<!--{{activity.name}}--></h2>
    <h2 class="h5 mb-0" *ngIf="!activities">Loading</h2>

  </div>
  <!-- Tabs -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
          <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" [disabled]=loading aria-controls="summary" aria-selected="true" (click)="summaryClicked()">Summary</button>
      </li>
      <li class="nav-item" role="presentation">
          <button class="nav-link" id="study-tab" data-bs-toggle="tab" data-bs-target="#study" type="button" role="tab" [disabled]=loading aria-controls="study" aria-selected="false">Study</button>
      </li>
      <li class="nav-item" role="presentation">
          <button class="nav-link" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph" type="button" role="tab" [disabled]=loading aria-controls="graph" aria-selected="false">Graphs</button>
      </li>
      <li class="nav-item" role="presentation">
          <button class="nav-link" id="maps-tab" data-bs-toggle="tab" data-bs-target="#maps" type="button" role="tab" [disabled]=loading aria-controls="maps" aria-selected="false" (click)="mapsClicked()">Map</button>
      </li>
  </ul>

  <!-- Tab Content -->
  <div class="tabs-container">
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active d-flex justify-content-between align-items-top " id="summary" role="tabpanel" aria-labelledby="summary-tab">
        <div class="mx-2 w-50 clickable">
          <h5>Overview</h5>
          <div [innerHTML]="overviewMessage"></div>
          <div *ngIf="loading" class="d-flex justify-content-center align-items-center w-100 h-100 flex-column">
            <div class="spinner-border mt-4" role="status"></div>
            <div class="mb-4">Loading data...</div>
          </div>
        </div>
        <div class="flex-grow-1 h-90 mx-2">
          <h5>Map</h5>
          <div class="thin-grey-border w-100 h-100" id="map-overview">
            <div *ngIf="overviewMap==null" class="d-flex justify-content-center align-items-center w-100 h-100 flex-column">
              <div class="spinner-border mt-4" role="status"></div>
              <div class="mb-4">Loading map...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade d-flex flex-column h-100" id="study" role="tabpanel" aria-labelledby="study-tab">
        <!--<app-activity-study *ngIf="this.activity" [activity]="this.activity"></app-activity-study>-->
        <!-- Metric selector -->
        <div class="d-flex align-items-center justify-content-between flex-shrink-0">
          <div class="d-flex align-items-center mb-3">
            <label for="metricSelect" class="form-label me-2 fw-bold">Metric:</label>
            <select class="form-select w-auto" id="metricSelect" [(ngModel)]="selectedMetric" (change)="calculateMetrics()">
              <option *ngFor="let metric of metrics" [value]="metric">{{ metric }}</option>
            </select>
          </div>
        </div>
        <div class="max-h-40 min-h-15 w-auto mb-2 flex-shrink-0 overflow-auto">
          <table class="table table-striped mb-0 table-sm">
            <thead>
              <tr>
                <th>Name</th>
                <th>distance</th>
                <th>time</th>
                <th>25%</th>
                <th>50%</th>
                <th>75%</th>
                <th>Avg</th>
                <th>dev</th>
                <th>IQR</th>
                <th>Norm IQR</th>
                <th>%out</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let act of activities">
                <td>{{ act.name }}</td>
                <td>{{calcMetrics.get(act.id)?.dist ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.time ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.p25 ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.p50 ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.p75 ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.avg ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.dev ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.IQR ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.NormIQR ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.pOut ?? -1}}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="lower_row" class="w-100 mt-2 flex-grow-1 d-flex flex-row justify-content-start overflow-auto max-h-75">
          <div id="first_item" class="max-w-25 h-100 thin-curved-border mx-2 overflow-auto" *ngIf="recordsFits||showCalc; else recordsComponent">
            <div class="d-flex justify-content-between">
              <h5>Calculator</h5>
              <div>
                <i class="fa-solid fa-arrows-rotate clickable mx-1" (click)="clearPercents()" ></i>
                <i class="fa-solid fa-arrow-right-arrow-left clickable mx-1" (click)="switchCalcAndRecords()" *ngIf="!recordsFits"></i>
              </div>
            </div>
            <div>
              <div>Here you can see how many measurements of the selected metric fall between two values</div>
              <div class="mt-1">% between <input type="number" [(ngModel)]="lowerCalcBound" class="form-control w-auto d-inline-block short-input" (change)="calcPercentForCalculator()"> and <input type="number" [(ngModel)]="higherCalcBound" class="form-control w-auto d-inline-block short-input" (change)="calcPercentForCalculator()"> is:</div>
              <ul>
                <li *ngFor="let name_percent of calculatorPercentages">{{name_percent.name}}: {{name_percent.percent}}</li>
              </ul>
            </div>
          </div>
          <div id="second_item" class="h-100 thin-curved-border mx-2 d-flex flex-column">
            <div class="d-flex justify-content-between mb-1">
              <h5>Splits</h5>
              <div class="d-flex flex-row">
                <select (change)="updateSplits(splitValueSelect.value)" class="form-select w-auto" #splitValueSelect>
                  <option value="1">1</option>
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="-1">other</option>
                </select>
                <input type="number" [(ngModel)]="currentSplitDistance" class="form-control w-auto d-inline-block very-short-input ms-1" (change)="updateSplits()" *ngIf="customSplits">
                <select [(ngModel)]="currentSplitUnit" class="form-select w-auto" (change)="updateSplits()">
                  <option value="km">km</option>
                  <option value="mi">mi</option>
                </select>
              </div>
            </div>
            <div class="d-flex flex-grow-1 overflow-auto">
              <table class="table table-striped table-sm table-bordered ">
                <thead>
                  <tr>
                    <th>{{currentSplitUnit}}</th>
                    <th *ngFor="let act of activities">{{act.name}}</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngFor="let split of splits | keyvalue">
                    <td class="">{{ split.key }}</td>
                    <td class="" *ngFor="let m of split.value"> {{m}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div *ngIf="recordsFits" [ngTemplateOutlet]="recordsComponent"></div>
        </div>
      </div>


      <div class="tab-pane fade" id="graph" role="tabpanel" aria-labelledby="graph-tab">
        <!-- Metric selector -->
        <div class="d-flex align-items-center justify-content-between mb-1">
          <div class="d-flex align-items-center mb-3">
            <label for="metricSelect" class="form-label me-2 fw-bold">Metric:</label>
            <select class="form-select w-auto" id="metricSelect" [(ngModel)]="selectedMetric" (change)="updateChart()">
              <option *ngFor="let metric of metrics" [value]="metric">{{ metric }}</option>
            </select>
          </div>

          <div class="d-flex align-items-center mb-3">
            <label for="chartSelect" class="form-label me-2 fw-bold">Chart:</label>
            <select class="form-select w-auto me-2" id="chartSelect" [(ngModel)]="selectedChart" (change)="changeChart()">
              <option *ngFor="let chart of chartTypes" [value]="chart">{{ chart }}</option>
            </select>
            <button class="btn btn-secondary" (click)="open(chartSettingsModal)">Chart settings <i class="fa-solid fa-gear"></i></button>
          </div>
        </div>
        <div *ngIf="displayData==null || displayData.length==0">Nothing to see here. Either the data has yet to load, or there is no data to show.</div>
        <div class="w-100 h-90 d-flex">
          <ngx-charts-line-chart
            *ngIf="selectedChart=='line' && displayData!=null && displayData.length>0"
            [view]="view"
            [scheme]="colorScheme"
            [results]="displayData"
            [xAxisLabel]="xAxisRepresents"
            [legendTitle]="'legend'"
            [yAxisLabel]="selectedMetric"
            [legend]="false"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            [xAxis]="true"
            [yAxis]="true"
            [gradient]="true"
            [autoScale]="true"
            [yAxisTickFormatting]="yAxisTickFormat">
          </ngx-charts-line-chart>
          <div id="hist1" class="d-flex flex-column" *ngIf="selectedChart=='histogram'===true && displayData!=null && displayData.length>0">
            <h5 class="d-flex justify-content-center">{{histOpt1.name}}</h5>
            <ngx-charts-bar-vertical
              [view]="[view[0]/2,view[1]-25]"
              [results]="displayData[histOpt1.pos]"
              [xAxisLabel]="selectedMetric"
              [legendTitle]="'legend'"
              [yAxisLabel]="'Quantity'"
              [legend]="false"
              [showXAxisLabel]="true"
              [showYAxisLabel]="true"
              [xAxis]="true"
              [yAxis]="true"
              [gradient]="true"
              [barPadding]="0">
            </ngx-charts-bar-vertical>
          </div>
          <div id="hist2 d-flex flex-column justify-content-center" *ngIf="selectedChart=='histogram'===true && displayData!=null && displayData.length>0">
            <h5 class="d-flex justify-content-center">{{histOpt2.name}}</h5>
            <ngx-charts-bar-vertical
              [view]="[view[0]/2,view[1]-25]"
              [results]="displayData[histOpt2.pos]"
              [xAxisLabel]="selectedMetric"
              [legendTitle]="'legend'"
              [yAxisLabel]="'Quantity'"
              [legend]="false"
              [showXAxisLabel]="true"
              [showYAxisLabel]="true"
              [xAxis]="true"
              [yAxis]="true"
              [gradient]="true"
              [barPadding]="0">
            </ngx-charts-bar-vertical>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="maps" role="tabpanel" aria-labelledby="maps-tab">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-inline-block me-2">
            <h5 class="d-inline-block me-2">Number of maps to show:</h5>
            <select [(ngModel)]="mapsToShow" class="form-select w-auto d-inline-block" (change)="updateMaps()">
              <option *ngFor="let option of options" [value]="option">
                {{ option }}
              </option>
            </select>
          </div>
          <div class="d-inline-block me-2">
            <h5 class="d-inline-block me-2">Show only 1 activity per map:</h5>
            <select [(ngModel)]="showOnePerMap" class="form-select w-auto d-inline-block" (change)="updateMaps()">
              <option [ngValue]="true">Yes</option>
              <option [ngValue]="false">No</option>
            </select>
            <button class="btn btn-secondary ms-2" *ngIf="activities.length>4" (click)="open(mapsModal)"><i class="fa-solid fa-gear"></i></button>
          </div>
        </div>
        <div class="h-90 d-grid gap-2" [ngClass]="{'grid-1-3': mapsToShow <= 3, 'grid-2-2': mapsToShow == 4}">
          <div class="w-100 h-100 mx-2" *ngIf="mapsToShow>0">
            <h5></h5>
            <div class="thin-grey-border w-100 h-100" id="map-1">
              <div *ngIf="overviewMap==null">
                <div class="spinner-border mt-4" role="status"></div>
                <div class="mb-4">Loading map...</div>
              </div>
            </div>
          </div>
          <div class="w-100 h-100 mx-2" *ngIf="mapsToShow>1">
            <h5></h5>
            <div class="thin-grey-border w-100 h-100" id="map-2">
              <div *ngIf="overviewMap==null">
                <div class="spinner-border mt-4" role="status"></div>
                <div class="mb-4">Loading map...</div>
              </div>
            </div>
          </div>
          <div class="w-100 h-100 mx-2" *ngIf="mapsToShow>2">
            <h5></h5>
            <div class="thin-grey-border w-100 h-100" id="map-3">
              <div *ngIf="overviewMap==null">
                <div class="spinner-border mt-4" role="status"></div>
                <div class="mb-4">Loading map...</div>
              </div>
            </div>
          </div>
          <div class="w-100 h-100 mx-2" *ngIf="mapsToShow>3">
            <h5></h5>
            <div class="thin-grey-border w-100 h-100" id="map-4">
              <div *ngIf="overviewMap==null">
                <div class="spinner-border mt-4" role="status"></div>
                <div class="mb-4">Loading map...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<ng-template #chartSettingsModal let-modal> <!-- let-modal -->
  <div class="modal-header d-flex justify-content-between">
    <h5 class="modal-title">Chart settings</h5>
    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div *ngIf="selectedChart!=='histogram'">
      <div>
        X axis is:
        <select [(ngModel)]="xAxisRepresents" (change)="updateChart()" class="form-select w-auto d-inline-block">
          <option value="timeElapsed">Time Elapsed</option>
          <option value="timeOfDay">Time of day</option>
          <option value="totalDistance">Total distance</option>
        </select>
      </div>
      <div>If an x value has multiple y values, use
        <select [(ngModel)]="useAvgs" (change)="updateChart()" class="form-select w-auto d-inline-block">
          <option [value]="false">the first one</option>
          <option [value]="true">the average</option>
        </select></div>
      <div class="mt-2">
        <h5>Show</h5>
        <ul>

          <li *ngFor="let act of activities"><label><input type="checkbox" [checked]="!hiddenActs.has(act.id)" (change)="toggleAct(act.id)"> {{act.name}}</label></li>
        </ul>
      </div>
    </div>
    <div *ngIf="selectedChart==='histogram'">
      <div class="my-2">
        <label for="partitionNum" class="mx-2">Number of partitions</label>
        <input type="number" name="partitionNum" id="partitionNum" [(ngModel)]="partitionNum1" (change)="updateChart()" class="form-control w-auto d-inline-block">
      </div>
      <div class="my-2">
        <label for="histOpt1" class="mx-2" >Histogram 1 shows: </label>
        <select (change)="updateChart()" [(ngModel)]="histOpt1" class="form-select w-auto d-inline-block" name="histOpt1"><option *ngFor="let o of histOptions" [ngValue]="o"> {{o.name}} </option></select>
      </div>
      <div class="my-2">
        <label for="histOpt2" class="mx-2">Histogram 2 shows: </label>
        <select (change)="updateChart()" [(ngModel)]="histOpt2" class="form-select w-auto d-inline-block" name="histOpt2"><option *ngFor="let o of histOptions" [ngValue]="o"> {{o.name}} </option></select>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>

<ng-template #recordsComponent>
  <div id="third_item" class="max-w-25 h-100 thin-curved-border mx-2 overflow-auto flex-shrink-0 overflow-auto">
    <div class="d-flex justify-content-between">
      <h5>Records</h5>
      <i class="fa-solid fa-arrow-right-arrow-left clickable mx-1" (click)="switchCalcAndRecords()" *ngIf="!recordsFits"></i>
    </div>
    <div>
      <table class="table table-striped table-bordered mb-0">
        <thead>
          <tr>
            <th>Name</th>
            <th>Record</th>
            <th>By</th>
            <th>Activity</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of records" class="clickable" (click)="goTo(record.at(-1))">
            <td>{{ record[0] }}</td>
            <td>{{record[1] }}</td>
            <td>{{ record[2]}}</td>
            <td>{{ record[3]}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</ng-template>

<ng-template #mapsModal let-modal> <!-- let-modal -->
  <div class="modal-header d-flex justify-content-between">
    <h5 class="modal-title">Map settings</h5>
    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div>
      <div *ngFor="let act of activityPerMap;let i=index;">
        Map {{i+1}} shows:
        <select [(ngModel)]="activityPerMap[i]" (change)="updateMaps()" class="form-select w-auto d-inline-block">
          <option [value]="j" *ngFor="let act of activities;let j=index;">{{act.name}}</option>
        </select>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>



<!--
<div class="overflow-auto flex-grow-1 max-h-50">
          <table class="table mb-0 table-striped table-sm" >
            <thead>
              <tr>
                <th>Name</th>
                <th>distance</th>
                <th>time</th>
                <th>25%</th>
                <th>50%</th>
                <th>75%</th>
                <th>Avg</th>
                <th>dev</th>
                <th>IQR</th>
                <th>Norm IQR</th>
                <th>%out</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let act of activities">
                <td>{{ act.name }}</td>
                <td>{{calcMetrics.get(act.id)?.dist ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.time ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.p25 ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.p50 ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.p75 ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.avg ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.dev ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.IQR ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.NormIQR ?? -1}}</td>
                <td>{{calcMetrics.get(act.id)?.pOut ?? -1}}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="lower_row" class="w-100 mt-2 d-flex flex-row justify-content-start overflow-auto"> -->
